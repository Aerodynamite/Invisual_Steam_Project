<!DOCTYPE html>
<html>
<head>
    <title>Invisual Project</title>
</head>
<body>

<h1> API Tests </h1>
<div id="id01"></div>

    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

    <script>
        // Proxy
        var proxyUrl = 'http://localhost:3000/proxy';

        // Steam
        var webAPIKey = "YOURKEY"; // MAKE SURE THIS ISN'T FILLED IN WHEN COMMITTING TO GITHUB
        var userSteamID64 = "YOURID";

        // Official API URLs
        // (Documented here: https://developer.valvesoftware.com/wiki/Steam_Web_API)
        var playerSummaryUrl = "http://api.steampowered.com/ISteamUser/GetPlayerSummaries/v0002/?key=" + webAPIKey + "&steamids=" + userSteamID64 + "&format=json";

        // Unofficial API URLs
        // (Documented here: https://wiki.teamfortress.com/wiki/User:RJackson/StorefrontAPI
        // and here: https://wiki.teamfortress.com/wiki/WebAPI)
        var appdetailsUrl = "http://store.steampowered.com/api/appdetails/?appids="; // add the appid to the url
        var allGamesUrl = "http://api.steampowered.com/ISteamApps/GetAppList/v2";


        // Global Variables
        var IDs = [];
        var genres = [];

        // get all IDS + genres
        // WARNING: WILL PERFORM 16000 REQUESTS, MANY OF WHOM WILL FAIL!!!!
        // Getting IDs is ok, but the genres will fail a LOT
//        unOfficialAPI(allGamesUrl, getAllAppIDs);
        //

//        officialAPI(playerSummaryUrl, printPlayerSummaryProfile);
        unOfficialAPI(appdetailsUrl + "440", getGenresOfGame); // test for TF2 (id = 440)

        function officialAPI(url, func) {
            // Request URL through proxy
            $.get(proxyUrl, {urlToFetch: url})
                    .done(function (data) {
                        result = data.response;
                        console.log(result);
                        func(result);
                    }).fail(function () {
                        $('body').text('Request to ' + proxyUrl + ' failed!');
                    });
        }

        // Difference with officialAPI function is we don't need to take data.response
        function unOfficialAPI(url, func) {
            console.log("unOfficial API call with Func");
            // Request URL through proxy
            $.get(proxyUrl, {urlToFetch: url})
                    .done(function (data) {
                        console.log(data);
                        func(data);
                    }).fail(function () {
                        $('body').text('Request to ' + proxyUrl + ' failed!');
                    });
        }

        function printPlayerSummaryProfile(result) {
            // Currently only adds the player profile URL to the HTML
            var out = "";

            out += "<h2>" + result.players[0].personaname + "</h2>";
            out += "<p> Profile url: <a href=\"" + result.players[0].profileurl + "\">" + result.players[0].profileurl + "</a></p>";

            console.log(out);

            document.getElementById("id01").innerHTML = out;
        }

        function getAllAppIDs(data) {
            console.log("Getting all app IDs..");
            var apps = data.applist.apps.length;

            for (var i = 0; i < apps; i++) {
                IDs[IDs.length] = data.applist.apps[i].appid;
            }
            console.log("Finished!");

            // A LOT WILL FAIL IF THERE ARE TOO MANY IDs
            getAllGenres();
        }

        function getAllGenres() {
            console.log("Getting all Genres");
            for (var i = 0; i < IDs.length; i++) {
                unOfficialAPI(appdetailsUrl + IDs[i], getGenresOfGame);
            }
            console.log("Finished");
        }

        // Saves genres of game into global genres array
        // And temporarily also prints out the genres of the game on the web page in an unordered list
        function getGenresOfGame(appDetails) {
            console.log("saving Genres..");
            var keys = [];
            for (var key in appDetails) {
                keys.push(key);
            }
            var idKey = keys[0];

            var out = "<h2>Genres of " + appDetails[idKey].data.name + "</h2><ul>";

            for (var i = 0; i < appDetails[idKey].data.genres.length; i++) {
                var genre = appDetails[idKey].data.genres[i].description;
                genres.push(genre);
                out += "<li>" + genre + "</li>";
            }
            out += "</ul>"

            document.getElementById("id01").innerHTML = out;
            console.log("Finished Saving!");
        }

    </script>

</body>
</html>